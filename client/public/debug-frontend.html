<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wunschliste Frontend Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #339af0; }
        #results { margin-top: 20px; padding: 20px; background: #2a2a2a; border-radius: 5px; }
        .user-info { background: #3a3a3a; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üêõ Wunschliste Frontend Debug</h1>
    
    <div class="user-info">
        <h3>User Status</h3>
        <div id="userStatus">Nicht eingeloggt</div>
        <button onclick="checkUserStatus()">User Status pr√ºfen</button>
        <button onclick="quickLogin()">Schnell-Login (test_role_user)</button>
    </div>
    
    <div>
        <h3>Wunschliste Tests</h3>
        <button onclick="testWishlistLoad()">Wunschliste laden</button>
        <button onclick="testAddToWishlist()">Spiel zur Wunschliste hinzuf√ºgen</button>
        <button onclick="testRemoveFromWishlist()">Spiel aus Wunschliste entfernen</button>
    </div>
    
    <div>
        <h3>API Tests</h3>
        <button onclick="testGamesLoad()">Spiele laden</button>
        <button onclick="testBackendHealth()">Backend Health Check</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        let currentUser = null;
        let currentToken = null;
        
        const BASE_URL = 'http://localhost:8000';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
            console.log(message);
        }
        
        function updateUserStatus() {
            const statusDiv = document.getElementById('userStatus');
            if (currentUser) {
                statusDiv.innerHTML = `
                    <strong>Eingeloggt als:</strong> ${currentUser.username}<br>
                    <strong>Admin:</strong> ${currentUser.is_admin ? 'Ja' : 'Nein'}<br>
                    <strong>Developer:</strong> ${currentUser.is_developer ? 'Ja' : 'Nein'}<br>
                    <strong>Token:</strong> ${currentToken ? currentToken.substring(0, 20) + '...' : 'Kein Token'}
                `;
            } else {
                statusDiv.innerHTML = 'Nicht eingeloggt';
            }
        }
        
        async function checkUserStatus() {
            log('üîç Pr√ºfe User Status...', 'info');
            
            // Token aus localStorage
            const token = localStorage.getItem('token');
            if (!token) {
                log('‚ùå Kein Token im localStorage gefunden', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/users/me/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    currentToken = token;
                    updateUserStatus();
                    log(`‚úÖ User gefunden: ${user.username}`, 'success');
                } else {
                    log(`‚ùå User-Abfrage fehlgeschlagen: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Fehler beim User-Check: ${error.message}`, 'error');
            }
        }
        
        async function quickLogin() {
            log('üîë F√ºhre Schnell-Login durch...', 'info');
            
            const loginData = {
                username: 'test_role_user',
                password: 'testpassword123'
            };
            
            try {
                const response = await fetch(`${BASE_URL}/login-json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    currentToken = data.access_token;
                    
                    // Token speichern wie das echte Frontend
                    localStorage.setItem('token', currentToken);
                    
                    updateUserStatus();
                    log(`‚úÖ Login erfolgreich: ${currentUser.username}`, 'success');
                } else {
                    log(`‚ùå Login fehlgeschlagen: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Login-Fehler: ${error.message}`, 'error');
            }
        }
        
        async function testWishlistLoad() {
            if (!currentToken) {
                log('‚ùå Nicht eingeloggt', 'error');
                return;
            }
            
            log('üìã Lade Wunschliste...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/wishlist/`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const wishlist = await response.json();
                    log(`‚úÖ Wunschliste geladen: ${wishlist.length} Spiele`, 'success');
                    wishlist.forEach(game => {
                        log(`  - ${game.title} (ID: ${game.id})`, 'info');
                    });
                } else {
                    log(`‚ùå Wunschliste laden fehlgeschlagen: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Wunschliste-Fehler: ${error.message}`, 'error');
            }
        }
        
        async function testAddToWishlist() {
            if (!currentToken) {
                log('‚ùå Nicht eingeloggt', 'error');
                return;
            }
            
            // Verwende Game ID 2 (THRONE AND LIBERTY)
            const gameId = 2;
            log(`üíú F√ºge Spiel ${gameId} zur Wunschliste hinzu...`, 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/wishlist/${gameId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                log(`üîß Response Status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ ${result.message}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Hinzuf√ºgen fehlgeschlagen: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Hinzuf√ºgen-Fehler: ${error.message}`, 'error');
            }
        }
        
        async function testRemoveFromWishlist() {
            if (!currentToken) {
                log('‚ùå Nicht eingeloggt', 'error');
                return;
            }
            
            // Verwende Game ID 1
            const gameId = 1;
            log(`üíî Entferne Spiel ${gameId} aus der Wunschliste...`, 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/wishlist/${gameId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ ${result.message}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Entfernen fehlgeschlagen: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Entfernen-Fehler: ${error.message}`, 'error');
            }
        }
        
        async function testGamesLoad() {
            log('üéÆ Lade Spiele...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/games/`);
                
                if (response.ok) {
                    const games = await response.json();
                    log(`‚úÖ ${games.length} Spiele geladen`, 'success');
                    games.forEach(game => {
                        log(`  - ${game.title} (ID: ${game.id})`, 'info');
                    });
                } else {
                    log(`‚ùå Spiele laden fehlgeschlagen: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Spiele-Fehler: ${error.message}`, 'error');
            }
        }
        
        async function testBackendHealth() {
            log('üîß Teste Backend Health...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/health`);
                
                if (response.ok) {
                    const health = await response.json();
                    log(`‚úÖ Backend gesund: ${health.service}`, 'success');
                } else {
                    log(`‚ùå Backend Health fehlgeschlagen: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Backend nicht erreichbar: ${error.message}`, 'error');
            }
        }
        
        // Initial User Status check
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Frontend Debug gestartet', 'info');
            checkUserStatus();
        });
    </script>
</body>
</html>